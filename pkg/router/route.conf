{{range $version := .Versions}}
upstream {{$.Service}}-kt-mesh-{{$version}} {
  server {{$.Service}}-kt-mesh-{{$version}};
}
{{end}}
upstream {{.Service}}-kt-origin {
  server {{.Service}}-kt-origin;
}

server {
{{range $port := .Ports}}
    listen  {{$port}};
{{end}}
    server_name  {{.Service}};
    underscores_in_headers  on;

    location / {
        proxy_redirect off;
        proxy_http_version 1.1;
        set $invalid_version "";

        if ($http_kt_version ~ .) {
            set $invalid_version "Y";
        }
    {{range $version := .Versions}}
        if ($http_kt_version = "{{$version}}") {
            proxy_pass  http://{{$.Service}}-kt-mesh-{{$version}};
            set $invalid_version "N";
        }
    {{end}}
        if ( $invalid_version = "Y" ) {
            return 404 "404 - Version $http_kt_version of service {{.Service}} not available";
        }

        proxy_pass  http://{{.Service}}-kt-origin;
    }
}
